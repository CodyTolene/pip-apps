function PipTris(){function x(){g.setColor(0,0,0),g.fillRect(0,0,s,p)}function L(){for(let a=l-1;a>=0;a--){let c=!0;for(let d=0;d<b;d++)if(!f[a*b+d]){c=!1;break}if(c){for(let c=0;c<b;c++)q(c,a);for(let c=a;c>0;c--)for(let a=0;a<b;a++)f[c*b+a]=f[(c-1)*b+a];for(let a=0;a<b;a++)f[a]=0;w+=100,a++}}}function n(a){for(let c=0;c<a.shape.length;c++)for(let d=0;d<a.shape[c].length;d++){if(!a.shape[c][d])continue;let e=a.x+d,g=a.y+c;if(e<0||e>=b||g>=l||g>=0&&f[g*b+e])return!0}return!1}function M(a,b){u.apply(),g.fillRect(h+a*c,i+b*c,h+(a+1)*c-1,i+(b+1)*c-1)}function m(a){u.set(0,1,0).apply(),g.drawRect(a.x1,a.y1,a.x2,a.y2)}function j(b){for(let c=0;c<a.shape.length;c++)for(let d=0;d<a.shape[c].length;d++)a.shape[c][d]&&(b?q(a.x+d,a.y+c):M(a.x+d,a.y+c))}function y(){u.apply();for(let a=0;a<l;a++)for(let c=0;c<b;c++)f[a*b+c]?M(c,a):q(c,a)}function N(){x();const a=s/2;const b=p/2;g.clear(),g.setColor('#0F0'),g.setFont('6x8',4),g.drawString('GAME OVER',a,b-20),g.setColor('#FFF'),g.setFont('6x8',2),g.drawString('Press    to RESTART',a,b+15),O('USER/Piptris/gear.json',a-45,b+1),g.setColor('#0F0'),g.setFont('6x8',2),g.drawString('Score: '+w,a,b+50),r=setInterval(()=>{BTN_PLAY.read()&&(clearInterval(r),T())},100)}function O(a,b,c){try{let e=fs.readFileSync(a);let d=JSON.parse(e);let f={bpp:d.bpp,buffer:atob(d.buffer),height:d.height,transparent:d.transparent,width:d.width};u.apply(),g.drawImage(f,b,c)}catch(a){console.log('Failed to load image:',a)}}function P(){if(!a||k)return;if(j(!0),a.y++,n(a)&&(a.y--,j(!1),Q(a),L(),y(),A(),n(a))){k=!0,clearInterval(d),setTimeout(N,50);return}j(!1),m(t);const c=BTN_PLAY.read();const b=c?100:C;d._interval!==b&&(clearInterval(d),d=setInterval(P,b))}function X(){x();const a=s/2;const b=p/2;g.clear(),g.setColor('#0F0'),g.setFont('6x8',4),g.drawString(U,a,b-20),g.setColor('#FFF'),g.setFont('6x8',2),g.drawString('Press    to START',a,b+15),O('USER/Piptris/gear.json',a-34,b+1),g.setColor('#FFF'),g.setFont('6x8',1),g.drawString(' v'+V,a-15,p-25)}function Y(){if(!a||k)return;j(!0);while(!n(a))a.y++;a.y--,j(!1),Q(a),L(),y(),A(),j(!1)}function q(a,b){g.setColor(0,0,0),g.fillRect(h+a*c,i+b*c,h+(a+1)*c-1,i+(b+1)*c-1)}function z(){let c=Math.floor(Math.random()*K.length);let a=K[c];let d=Math.floor((b-a[0].length)/2);return{shape:a,x:d,y:0}}function Z(){R()}function _(b){let a=Date.now();if(a-H<W)return;H=a,b===0?Y():a4(b)}function $(a){a2(a>0?1:-1)}function a0(){S(),clearInterval(d),bC.clear(1).flip(),E.reboot()}function a1(){try{o=fs.readdir(J).filter(a=>a.endsWith('.wav')).sort()}catch(a){print('Failed to load Piptris music files:',a),o=[]}}function Q(a){for(let c=0;c<a.shape.length;c++)for(let d=0;d<a.shape[c].length;d++)a.shape[c][d]&&(f[(a.y+c)*b+a.x+d]=1)}function a2(c){if(k||!a)return;let b=a.x;if(a.x+=c,n(a)){a.x=b;return}for(let d=0;d<a.shape.length;d++)for(let e=0;e<a.shape[d].length;e++)a.shape[d][e]&&q(b+e,a.y+d);j(!1),m(e),m(t)}function R(){if(!o.length)return;const a=o[Math.floor(Math.random()*o.length)];Pip.audioStop(),Pip.audioStart(J+'/'+a),rd.setVol(.5)}function a3(){f.fill(0),g.setColor(0,0,0),g.fillRect(h,i,h+b*c-1,i+l*c-1)}function a4(f){if(k||!a)return;const b=a.shape;const d=f>0?b[0].map((c,a)=>b.map(b=>b[b.length-1-a])):b[0].map((c,a)=>b.map(b=>b[a]).reverse());const c=a.shape;if(a.shape=d,n(a)){a.shape=c;return}for(let e=0;e<c.length;e++)for(let g=0;g<c[e].length;g++)c[e][g]&&q(a.x+g,a.y+e);j(!1),m(e),m(t)}function S(){Pip.removeAllListeners(D),Pip.removeAllListeners(F),Pip.removeAllListeners(G),Pip.removeAllListeners(I)}function a5(){Pip.on(D,_),Pip.on(F,$),Pip.on(G,a0),Pip.on(I,Z)}function A(){a=v||z(),v=z(),n(a)&&(k=!0,clearInterval(d),setTimeout(()=>{N()},50))}function T(){clearInterval(d),S(),a1(),R(),w=0,k=!1,a=null,v=z(),x(),a3(),m(t),m(e),A(),y(),a5(),d=setInterval(P,C)}const B={};const U='Piptris';const V='2.0.0';let a=null;let C=800;let v=null;let c=10;let k=!1;let d=null;let r=null;let o=[];let w=0;const s=g.getWidth();const p=g.getHeight();const e={x1:60,x2:s-60,y1:10,y2:p-10};const b=10;const l=20;const f=new Uint8Array(b*l);const h=(e.x1+e.x2)/2-c*b/2;const i=e.y1+(e.y2-e.y1)/2-c*l/2;const t={x1:h-1,y1:i-1,x2:h+b*c,y2:i+l*c};const D='knob1';const F='knob2';const G='torch';const W=100;let H=0;const I='audioStopped';const J='USER/Piptris';const K=[[[1,1,1,1]],[[1,1,1,1]],[[1,1,0],[0,1,1]],[[0,1,1],[1,1,0]],[[1,0,0],[1,1,1]],[[0,0,1],[1,1,1]],[[0,1,0],[1,1,1]],[[1,1],[1,1]]];const u={self:[0,1,0],apply:function(){g.setColor(this.self[0],this.self[1],this.self[2])},get:function(){return this.self},set:function(a,b,c,d){if(a===undefined||b===undefined||c===undefined||d){const a=g.getColor().toString(16);for(let e=0;e<3;e++)this.self[e]=parseInt(a.charAt(e),16)/15}else this.self[0]=a,this.self[1]=b,this.self[2]=c;return this}};return B.run=function(){bC.clear(),X(),r=setInterval(()=>{BTN_PLAY.read()&&(clearInterval(r),T())},100)},B}PipTris().run()