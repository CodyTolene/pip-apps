function PipTris(){function x(){g.setColor('#000'),g.fillRect(0,0,v,q)}function L(){for(let a=m-1;a>=0;a--){let b=!0;for(let d=0;d<c;d++)if(!e[a*c+d]){b=!1;break}if(b){for(let b=0;b<c;b++)s(b,a);for(let b=a;b>0;b--)for(let a=0;a<c;a++)e[b*c+a]=e[(b-1)*c+a];for(let a=0;a<c;a++)e[a]=0;u+=100,a++}}}function o(a){for(let b=0;b<a.shape.length;b++)for(let d=0;d<a.shape[b].length;d++){if(!a.shape[b][d])continue;let f=a.x+d,g=a.y+b;if(f<0||f>=c||g>=m||g>=0&&e[g*c+f])return!0}return!1}function M(a,c){n.apply(),g.fillRect(f+a*b,h+c*b,f+(a+1)*b-1,h+(c+1)*b-1)}function w(a){n.set(0,1,0).apply(),g.drawRect(a.x1,a.y1,a.x2,a.y2)}function j(b){for(let c=0;c<a.shape.length;c++)for(let d=0;d<a.shape[c].length;d++)a.shape[c][d]&&(b?s(a.x+d,a.y+c):M(a.x+d,a.y+c))}function y(){n.apply();for(let a=0;a<m;a++)for(let b=0;b<c;b++)e[a*c+b]?M(b,a):s(b,a);Y(),X()}function N(){x();const a=v/2;const b=q/2;g.clear(),g.setColor('#0F0'),g.setFont('6x8',4),g.drawString('GAME OVER',a,b-20),g.setColor('#FFF'),g.setFont('6x8',2),g.drawString('Press    to RESTART',a,b+15),O('USER/Piptris/gear.json',a-45,b+1),g.setColor('#0F0'),g.setFont('6x8',2),g.drawString('Score: '+u,a,b+50),t=setInterval(()=>{BTN_PLAY.read()&&(clearInterval(t),T())},100)}function O(a,b,c){try{let e=fs.readFileSync(a);let d=JSON.parse(e);let f={bpp:d.bpp,buffer:atob(d.buffer),height:d.height,transparent:d.transparent,width:d.width};n.apply(),g.drawImage(f,b,c)}catch(a){console.log('Failed to load image:',a)}}function X(){if(!k)return;const c=i.x2+65;const a=i.y2-60;const e=40;const h=40;g.setColor('#000'),g.fillRect(c-e/2-2,a+15,c+e/2,a+15+h),g.setFont('6x8',2),g.setColor('#FFF'),g.drawString('NEXT',c,a),n.apply();const d=k.shape;const j=d[0].length*b;const f=c-j/2-2;for(let i=0;i<d.length;i++)for(let k=0;k<d[i].length;k++)d[i][k]&&g.fillRect(f+k*b,a+20+i*b,f+(k+1)*b-1,a+20+(i+1)*b-1)}function P(){if(!a||l)return;if(j(!0),a.y++,o(a)&&(a.y--,j(!1),Q(a),L(),A(),o(a))){l=!0,clearInterval(d),setTimeout(N,50);return}j(!1),w(i);const c=BTN_PLAY.read();const b=c?100:C;d._interval!==b&&(clearInterval(d),d=setInterval(P,b))}function Y(){const a=i.x2+65;const b=i.y1+25;const c=20;g.setFont('6x8',2),g.setColor('#FFF'),g.drawString('SCORE',a,b),n.apply(),g.drawString(u.toString(),a,b+c)}function Z(){x();const a=v/2;const b=q/2;g.clear(),g.setColor('#0F0'),g.setFont('6x8',4),g.drawString(U,a,b-20),g.setColor('#FFF'),g.setFont('6x8',2),g.drawString('Press    to START',a,b+15),O('USER/Piptris/gear.json',a-34,b+1),g.setColor('#FFF'),g.setFont('6x8',1),g.drawString(' v'+V,a-15,q-25)}function _(){if(!a||l)return;j(!0);while(!o(a))a.y++;a.y--,j(!1),Q(a),L(),y(),A(),j(!1)}function s(a,c){g.setColor('#000'),g.fillRect(f+a*b,h+c*b,f+(a+1)*b-1,h+(c+1)*b-1)}function z(){let b=Math.floor(Math.random()*K.length);let a=K[b];let d=Math.floor((c-a[0].length)/2);return{shape:a,x:d,y:0}}function $(){R()}function a0(b){let a=Date.now();if(a-H<W)return;H=a,b===0?_():a6(b)}function a1(a){a4(a>0?1:-1)}function a2(){S(),clearInterval(d),bC.clear(1).flip(),E.reboot()}function a3(){try{p=fs.readdir(J).filter(a=>a.endsWith('.wav')).sort()}catch(a){print('Failed to load Piptris music files:',a),p=[]}}function Q(a){for(let b=0;b<a.shape.length;b++)for(let d=0;d<a.shape[b].length;d++)a.shape[b][d]&&(e[(a.y+b)*c+a.x+d]=1)}function a4(c){if(l||!a)return;let b=a.x;if(a.x+=c,o(a)){a.x=b;return}for(let d=0;d<a.shape.length;d++)for(let e=0;e<a.shape[d].length;e++)a.shape[d][e]&&s(b+e,a.y+d);j(!1),w(i)}function R(){if(!p.length)return;const a=p[Math.floor(Math.random()*p.length)];Pip.audioStop(),Pip.audioStart(J+'/'+a),rd.setVol(.5)}function a5(){e.fill(0),g.setColor('#000'),g.fillRect(f,h,f+c*b-1,h+m*b-1)}function a6(e){if(l||!a)return;const b=a.shape;const d=e>0?b[0].map((c,a)=>b.map(b=>b[b.length-1-a])):b[0].map((c,a)=>b.map(b=>b[a]).reverse());const c=a.shape;if(a.shape=d,o(a)){a.shape=c;return}for(let f=0;f<c.length;f++)for(let g=0;g<c[f].length;g++)c[f][g]&&s(a.x+g,a.y+f);j(!1),w(i)}function S(){Pip.removeAllListeners(D),Pip.removeAllListeners(F),Pip.removeAllListeners(G),Pip.removeAllListeners(I)}function a7(){Pip.on(D,a0),Pip.on(F,a1),Pip.on(G,a2),Pip.on(I,$)}function A(){k||(k=z()),a=k,k=z(),y(),o(a)&&(l=!0,clearInterval(d),setTimeout(()=>{N()},50))}function T(){clearInterval(d),S(),a3(),R(),u=0,l=!1,a=null,k=z(),x(),a5(),w(i),A(),y(),a7(),d=setInterval(P,C)}const B={};const U='Piptris';const V='2.0.0';let a=null;let C=800;let k=null;let b=10;let l=!1;let d=null;let t=null;let p=[];let u=0;const v=g.getWidth();const q=g.getHeight();const r={x1:60,x2:v-60,y1:10,y2:q-10};const c=10;const m=20;const e=new Uint8Array(c*m);const f=(r.x1+r.x2)/2-b*c/2;const h=r.y1+(r.y2-r.y1)/2-b*m/2;const i={x1:f-1,y1:h-1,x2:f+c*b,y2:h+m*b};const D='knob1';const F='knob2';const G='torch';const W=100;let H=0;const I='audioStopped';const J='USER/Piptris';const K=[[[1,1,1,1]],[[1,1,1,1]],[[1,1,0],[0,1,1]],[[0,1,1],[1,1,0]],[[1,0,0],[1,1,1]],[[0,0,1],[1,1,1]],[[0,1,0],[1,1,1]],[[1,1],[1,1]]];const n={self:[0,1,0],apply:function(){g.setColor(this.self[0],this.self[1],this.self[2])},get:function(){return this.self},set:function(a,b,c,d){if(a===undefined||b===undefined||c===undefined||d){const a=g.getColor().toString(16);for(let e=0;e<3;e++)this.self[e]=parseInt(a.charAt(e),16)/15}else this.self[0]=a,this.self[1]=b,this.self[2]=c;return this}};return B.run=function(){bC.clear(),Z(),t=setInterval(()=>{BTN_PLAY.read()&&(clearInterval(t),T())},100)},B}PipTris().run()