function PipTris(){function x(){g.setColor(0,0,0),g.fillRect(0,0,t,o)}function L(){for(let a=k-1;a>=0;a--){let c=!0;for(let d=0;d<b;d++)if(!e[a*b+d]){c=!1;break}if(c){for(let c=0;c<b;c++)q(c,a);for(let c=a;c>0;c--)for(let a=0;a<b;a++)e[c*b+a]=e[(c-1)*b+a];for(let a=0;a<b;a++)e[a]=0;s+=100,a++}}}function m(a){for(let c=0;c<a.shape.length;c++)for(let d=0;d<a.shape[c].length;d++){if(!a.shape[c][d])continue;let f=a.x+d,g=a.y+c;if(f<0||f>=b||g>=k||g>=0&&e[g*b+f])return!0}return!1}function M(a,b){u.apply(),g.fillRect(f+a*c,h+b*c,f+(a+1)*c-1,h+(b+1)*c-1)}function v(a){u.set(0,1,0).apply(),g.drawRect(a.x1,a.y1,a.x2,a.y2)}function i(b){for(let c=0;c<a.shape.length;c++)for(let d=0;d<a.shape[c].length;d++)a.shape[c][d]&&(b?q(a.x+d,a.y+c):M(a.x+d,a.y+c))}function y(){u.apply();for(let a=0;a<k;a++)for(let c=0;c<b;c++)e[a*b+c]?M(c,a):q(c,a);X()}function N(){x();const a=t/2;const b=o/2;g.clear(),g.setColor('#0F0'),g.setFont('6x8',4),g.drawString('GAME OVER',a,b-20),g.setColor('#FFF'),g.setFont('6x8',2),g.drawString('Press    to RESTART',a,b+15),O('USER/Piptris/gear.json',a-45,b+1),g.setColor('#0F0'),g.setFont('6x8',2),g.drawString('Score: '+s,a,b+50),r=setInterval(()=>{BTN_PLAY.read()&&(clearInterval(r),T())},100)}function O(a,b,c){try{let e=fs.readFileSync(a);let d=JSON.parse(e);let f={bpp:d.bpp,buffer:atob(d.buffer),height:d.height,transparent:d.transparent,width:d.width};u.apply(),g.drawImage(f,b,c)}catch(a){console.log('Failed to load image:',a)}}function P(){if(!a||j)return;if(i(!0),a.y++,m(a)&&(a.y--,i(!1),Q(a),L(),y(),A(),m(a))){j=!0,clearInterval(d),setTimeout(N,50);return}i(!1),v(l);const c=BTN_PLAY.read();const b=c?100:C;d._interval!==b&&(clearInterval(d),d=setInterval(P,b))}function X(){const a=l.x2+65;const b=l.y1+25;const c=20;g.setFont('6x8',2),g.setColor(1,1,1),g.drawString('SCORE',a,b),g.drawString(s.toString(),a,b+c)}function Y(){x();const a=t/2;const b=o/2;g.clear(),g.setColor('#0F0'),g.setFont('6x8',4),g.drawString(U,a,b-20),g.setColor('#FFF'),g.setFont('6x8',2),g.drawString('Press    to START',a,b+15),O('USER/Piptris/gear.json',a-34,b+1),g.setColor('#FFF'),g.setFont('6x8',1),g.drawString(' v'+V,a-15,o-25)}function Z(){if(!a||j)return;i(!0);while(!m(a))a.y++;a.y--,i(!1),Q(a),L(),y(),A(),i(!1)}function q(a,b){g.setColor(0,0,0),g.fillRect(f+a*c,h+b*c,f+(a+1)*c-1,h+(b+1)*c-1)}function z(){let c=Math.floor(Math.random()*K.length);let a=K[c];let d=Math.floor((b-a[0].length)/2);return{shape:a,x:d,y:0}}function _(){R()}function $(b){let a=Date.now();if(a-H<W)return;H=a,b===0?Z():a5(b)}function a0(a){a3(a>0?1:-1)}function a1(){S(),clearInterval(d),bC.clear(1).flip(),E.reboot()}function a2(){try{n=fs.readdir(J).filter(a=>a.endsWith('.wav')).sort()}catch(a){print('Failed to load Piptris music files:',a),n=[]}}function Q(a){for(let c=0;c<a.shape.length;c++)for(let d=0;d<a.shape[c].length;d++)a.shape[c][d]&&(e[(a.y+c)*b+a.x+d]=1)}function a3(c){if(j||!a)return;let b=a.x;if(a.x+=c,m(a)){a.x=b;return}for(let d=0;d<a.shape.length;d++)for(let e=0;e<a.shape[d].length;e++)a.shape[d][e]&&q(b+e,a.y+d);i(!1),v(l)}function R(){if(!n.length)return;const a=n[Math.floor(Math.random()*n.length)];Pip.audioStop(),Pip.audioStart(J+'/'+a),rd.setVol(.5)}function a4(){e.fill(0),g.setColor(0,0,0),g.fillRect(f,h,f+b*c-1,h+k*c-1)}function a5(e){if(j||!a)return;const b=a.shape;const d=e>0?b[0].map((c,a)=>b.map(b=>b[b.length-1-a])):b[0].map((c,a)=>b.map(b=>b[a]).reverse());const c=a.shape;if(a.shape=d,m(a)){a.shape=c;return}for(let f=0;f<c.length;f++)for(let g=0;g<c[f].length;g++)c[f][g]&&q(a.x+g,a.y+f);i(!1),v(l)}function S(){Pip.removeAllListeners(D),Pip.removeAllListeners(F),Pip.removeAllListeners(G),Pip.removeAllListeners(I)}function a6(){Pip.on(D,$),Pip.on(F,a0),Pip.on(G,a1),Pip.on(I,_)}function A(){a=w||z(),w=z(),m(a)&&(j=!0,clearInterval(d),setTimeout(()=>{N()},50))}function T(){clearInterval(d),S(),a2(),R(),s=0,j=!1,a=null,w=z(),x(),a4(),v(l),A(),y(),a6(),d=setInterval(P,C)}const B={};const U='Piptris';const V='2.0.0';let a=null;let C=800;let w=null;let c=10;let j=!1;let d=null;let r=null;let n=[];let s=0;const t=g.getWidth();const o=g.getHeight();const p={x1:60,x2:t-60,y1:10,y2:o-10};const b=10;const k=20;const e=new Uint8Array(b*k);const f=(p.x1+p.x2)/2-c*b/2;const h=p.y1+(p.y2-p.y1)/2-c*k/2;const l={x1:f-1,y1:h-1,x2:f+b*c,y2:h+k*c};const D='knob1';const F='knob2';const G='torch';const W=100;let H=0;const I='audioStopped';const J='USER/Piptris';const K=[[[1,1,1,1]],[[1,1,1,1]],[[1,1,0],[0,1,1]],[[0,1,1],[1,1,0]],[[1,0,0],[1,1,1]],[[0,0,1],[1,1,1]],[[0,1,0],[1,1,1]],[[1,1],[1,1]]];const u={self:[0,1,0],apply:function(){g.setColor(this.self[0],this.self[1],this.self[2])},get:function(){return this.self},set:function(a,b,c,d){if(a===undefined||b===undefined||c===undefined||d){const a=g.getColor().toString(16);for(let e=0;e<3;e++)this.self[e]=parseInt(a.charAt(e),16)/15}else this.self[0]=a,this.self[1]=b,this.self[2]=c;return this}};return B.run=function(){bC.clear(),Y(),r=setInterval(()=>{BTN_PLAY.read()&&(clearInterval(r),T())},100)},B}PipTris().run()