function PipTris(){function G(){for(let a=j-1;a>=0;a--){let c=!0;for(let e=0;e<b;e++)if(!d[a*b+e]){c=!1;break}if(c){for(let c=0;c<b;c++)o(c,a);for(let c=a;c>0;c--)for(let a=0;a<b;a++)d[c*b+a]=d[(c-1)*b+a];for(let a=0;a<b;a++)d[a]=0;x+=100,a++}}}function n(a){for(let c=0;c<a.shape.length;c++)for(let e=0;e<a.shape[c].length;e++){if(!a.shape[c][e])continue;let f=a.x+e,g=a.y+c;if(f<0||f>=b||g>=j||g>=0&&d[g*b+f])return!0}return!1}function H(a,b){q.apply(),g.fillRect(e+a*c,f+b*c,e+(a+1)*c-1,f+(b+1)*c-1)}function k(a){q.set(0,1,0).apply(),g.drawRect(a.x1,a.y1,a.x2,a.y2)}function i(b){for(let c=0;c<a.shape.length;c++)for(let d=0;d<a.shape[c].length;d++)a.shape[c][d]&&(b?o(a.x+d,a.y+c):H(a.x+d,a.y+c))}function t(){q.apply();for(let a=0;a<j;a++)for(let c=0;c<b;c++)d[a*b+c]?H(c,a):o(c,a)}function P(){if(!a||l)return;i(!0),a.y++,n(a)&&(a.y--,i(!1),I(a),G(),t(),v()),i(!1),k(p)}function Q(){if(!a||l)return;i(!0);while(!n(a))a.y++;a.y--,i(!1),I(a),G(),t(),v(),i(!1)}function o(a,b){g.setColor(0,0,0),g.fillRect(e+a*c,f+b*c,e+(a+1)*c-1,f+(b+1)*c-1)}function u(){let c=Math.floor(Math.random()*F.length);let a=F[c];let d=Math.floor((b-a[0].length)/2);return{shape:a,x:d,y:0}}function R(){J()}function S(b){let a=Date.now();if(a-B<O)return;B=a,b===0?Q():Y(b)}function T(a){W(a>0?1:-1)}function U(){K(),clearInterval(s),bC.clear(1).flip(),E.reboot()}function V(){try{m=fs.readdir(D).filter(a=>a.endsWith('.wav')).sort()}catch(a){print('Failed to load Piptris music files:',a),m=[]}}function I(a){for(let c=0;c<a.shape.length;c++)for(let e=0;e<a.shape[c].length;e++)a.shape[c][e]&&(d[(a.y+c)*b+a.x+e]=1)}function W(c){if(l||!a)return;let b=a.x;if(a.x+=c,n(a)){a.x=b;return}for(let d=0;d<a.shape.length;d++)for(let e=0;e<a.shape[d].length;e++)a.shape[d][e]&&o(b+e,a.y+d);i(!1),k(h),k(p)}function J(){if(!m.length)return;const a=m[Math.floor(Math.random()*m.length)];Pip.audioStop(),Pip.audioStart(D+'/'+a),rd.setVol(.5)}function X(){for(let a=0;a<d.length;a++)d[a]=0;g.setColor(0,0,0),g.fillRect(e,f,e+b*c-1,f+j*c-1)}function Y(e){if(l||!a)return;const b=a.shape;const d=e>0?b[0].map((c,a)=>b.map(b=>b[b.length-1-a])):b[0].map((c,a)=>b.map(b=>b[a]).reverse());const c=a.shape;if(a.shape=d,n(a)){a.shape=c;return}for(let f=0;f<c.length;f++)for(let g=0;g<c[f].length;g++)c[f][g]&&o(a.x+g,a.y+f);i(!1),k(h),k(p)}function K(){Pip.removeAllListeners(y),Pip.removeAllListeners(z),Pip.removeAllListeners(A),Pip.removeAllListeners(C)}function Z(){Pip.on(y,S),Pip.on(z,T),Pip.on(A,U),Pip.on(C,R)}function v(){a=r||u(),r=u(),n(a)&&(l=!0,q.set(0,1,0).apply(),g.setFontMonofonto18(),g.drawString('GAME OVER',e,f+40),clearInterval(s))}const w={};const _='Piptris';const $='2.0.0';let a=null;let L=800;let r=null;let c=10;let l=!1;let s=null;let m=[];let x=0;const M=g.getWidth();const N=g.getHeight();const h={x1:60,x2:M-60,y1:10,y2:N-10};const b=10;const j=20;const d=new Uint8Array(b*j);const e=(h.x1+h.x2)/2-c*b/2;const f=h.y1+(h.y2-h.y1)/2-c*j/2;const p={x1:e-1,y1:f-1,x2:e+b*c,y2:f+j*c};const y='knob1';const z='knob2';const A='torch';const O=100;let B=0;const C='audioStopped';const D='USER/Piptris';const F=[[[1,1,1,1]],[[1,1,0],[0,1,1]],[[0,1,1],[1,1,0]],[[1,0,0],[1,1,1]],[[0,0,1],[1,1,1]],[[0,1,0],[1,1,1]],[[1,1],[1,1]]];const q={self:[0,1,0],apply:function(){g.setColor(this.self[0],this.self[1],this.self[2])},get:function(){return this.self},set:function(a,b,c,d){if(a===undefined||b===undefined||c===undefined||d){const a=g.getColor().toString(16);for(let e=0;e<3;e++)this.self[e]=parseInt(a.charAt(e),16)/15}else this.self[0]=a,this.self[1]=b,this.self[2]=c;return this}};return w.run=function(){V(),J(),bC.clear(),k(p),X(),x=0,l=!1,r=u(),v(),t(),k(h),s=setInterval(P,L),K(),Z()},w}PipTris().run()