function PipTris(){function x(){g.setColor(0,0,0),g.fillRect(0,0,s,n)}function K(){for(let a=j-1;a>=0;a--){let c=!0;for(let d=0;d<b;d++)if(!e[a*b+d]){c=!1;break}if(c){for(let c=0;c<b;c++)p(c,a);for(let c=a;c>0;c--)for(let a=0;a<b;a++)e[c*b+a]=e[(c-1)*b+a];for(let a=0;a<b;a++)e[a]=0;w+=100,a++}}}function o(a){for(let c=0;c<a.shape.length;c++)for(let d=0;d<a.shape[c].length;d++){if(!a.shape[c][d])continue;let f=a.x+d,g=a.y+c;if(f<0||f>=b||g>=j||g>=0&&e[g*b+f])return!0}return!1}function L(a,b){u.apply(),g.fillRect(f+a*c,h+b*c,f+(a+1)*c-1,h+(b+1)*c-1)}function k(a){u.set(0,1,0).apply(),g.drawRect(a.x1,a.y1,a.x2,a.y2)}function i(b){for(let c=0;c<a.shape.length;c++)for(let d=0;d<a.shape[c].length;d++)a.shape[c][d]&&(b?p(a.x+d,a.y+c):L(a.x+d,a.y+c))}function y(){u.apply();for(let a=0;a<j;a++)for(let c=0;c<b;c++)e[a*b+c]?L(c,a):p(c,a)}function V(){x();const a=s/2;const b=n/2;g.clear(),g.setColor('#0F0'),g.setFont('6x8',4),g.drawString('GAME OVER',a,b-20),g.setColor('#FFF'),g.setFont('6x8',2),g.drawString('Press    to RESTART',a,b+15),M('USER/Piptris/gear.json',a-45,b+1),g.setColor('#0F0'),g.setFont('6x8',2),g.drawString('Score: '+w,a,b+50),r=setInterval(()=>{BTN_PLAY.read()&&(clearInterval(r),Q())},100)}function M(a,b,c){try{let e=fs.readFileSync(a);let d=JSON.parse(e);let f={bpp:d.bpp,buffer:atob(d.buffer),height:d.height,transparent:d.transparent,width:d.width};u.apply(),g.drawImage(f,b,c)}catch(a){console.log('Failed to load image:',a)}}function W(){if(!a||l)return;i(!0),a.y++,o(a)&&(a.y--,i(!1),N(a),K(),y(),A()),i(!1),k(t)}function X(){x();const a=s/2;const b=n/2;g.clear(),g.setColor('#0F0'),g.setFont('6x8',4),g.drawString(R,a,b-20),g.setColor('#FFF'),g.setFont('6x8',2),g.drawString('Press    to START',a,b+15),M('USER/Piptris/gear.json',a-34,b+1),g.setColor('#FFF'),g.setFont('6x8',1),g.drawString(' v'+S,a-15,n-25)}function Y(){if(!a||l)return;i(!0);while(!o(a))a.y++;a.y--,i(!1),N(a),K(),y(),A(),i(!1)}function p(a,b){g.setColor(0,0,0),g.fillRect(f+a*c,h+b*c,f+(a+1)*c-1,h+(b+1)*c-1)}function z(){let c=Math.floor(Math.random()*J.length);let a=J[c];let d=Math.floor((b-a[0].length)/2);return{shape:a,x:d,y:0}}function Z(){O()}function _(b){let a=Date.now();if(a-G<U)return;G=a,b===0?Y():a4(b)}function $(a){a2(a>0?1:-1)}function a0(){P(),clearInterval(q),bC.clear(1).flip(),E.reboot()}function a1(){try{m=fs.readdir(I).filter(a=>a.endsWith('.wav')).sort()}catch(a){print('Failed to load Piptris music files:',a),m=[]}}function N(a){for(let c=0;c<a.shape.length;c++)for(let d=0;d<a.shape[c].length;d++)a.shape[c][d]&&(e[(a.y+c)*b+a.x+d]=1)}function a2(c){if(l||!a)return;let b=a.x;if(a.x+=c,o(a)){a.x=b;return}for(let d=0;d<a.shape.length;d++)for(let e=0;e<a.shape[d].length;e++)a.shape[d][e]&&p(b+e,a.y+d);i(!1),k(d),k(t)}function O(){if(!m.length)return;const a=m[Math.floor(Math.random()*m.length)];Pip.audioStop(),Pip.audioStart(I+'/'+a),rd.setVol(.5)}function a3(){e.fill(0),g.setColor(0,0,0),g.fillRect(f,h,f+b*c-1,h+j*c-1)}function a4(f){if(l||!a)return;const b=a.shape;const e=f>0?b[0].map((c,a)=>b.map(b=>b[b.length-1-a])):b[0].map((c,a)=>b.map(b=>b[a]).reverse());const c=a.shape;if(a.shape=e,o(a)){a.shape=c;return}for(let d=0;d<c.length;d++)for(let g=0;g<c[d].length;g++)c[d][g]&&p(a.x+g,a.y+d);i(!1),k(d),k(t)}function P(){Pip.removeAllListeners(C),Pip.removeAllListeners(D),Pip.removeAllListeners(F),Pip.removeAllListeners(H)}function a5(){Pip.on(C,_),Pip.on(D,$),Pip.on(F,a0),Pip.on(H,Z)}function A(){a=v||z(),v=z(),o(a)&&(l=!0,clearInterval(q),setTimeout(()=>{V()},50))}function Q(){clearInterval(q),P(),a1(),O(),w=0,l=!1,a=null,v=z(),x(),a3(),k(t),k(d),A(),y(),a5(),q=setInterval(W,T)}const B={};const R='Piptris';const S='2.0.0';let a=null;let T=800;let v=null;let c=10;let l=!1;let q=null;let r=null;let m=[];let w=0;const s=g.getWidth();const n=g.getHeight();const d={x1:60,x2:s-60,y1:10,y2:n-10};const b=10;const j=20;const e=new Uint8Array(b*j);const f=(d.x1+d.x2)/2-c*b/2;const h=d.y1+(d.y2-d.y1)/2-c*j/2;const t={x1:f-1,y1:h-1,x2:f+b*c,y2:h+j*c};const C='knob1';const D='knob2';const F='torch';const U=100;let G=0;const H='audioStopped';const I='USER/Piptris';const J=[[[1,1,1,1]],[[1,1,0],[0,1,1]],[[0,1,1],[1,1,0]],[[1,0,0],[1,1,1]],[[0,0,1],[1,1,1]],[[0,1,0],[1,1,1]],[[1,1],[1,1]]];const u={self:[0,1,0],apply:function(){g.setColor(this.self[0],this.self[1],this.self[2])},get:function(){return this.self},set:function(a,b,c,d){if(a===undefined||b===undefined||c===undefined||d){const a=g.getColor().toString(16);for(let e=0;e<3;e++)this.self[e]=parseInt(a.charAt(e),16)/15}else this.self[0]=a,this.self[1]=b,this.self[2]=c;return this}};return B.run=function(){bC.clear(),X(),r=setInterval(()=>{BTN_PLAY.read()&&(clearInterval(r),Q())},100)},B}PipTris().run()