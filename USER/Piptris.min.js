function Piptris(){function x(){g.setColor('#000'),g.fillRect(0,0,v,r)}function O(){let a=0;for(let b=o-1;b>=0;b--){let d=!0;for(let e=0;e<c;e++)if(!f[b*c+e]){d=!1;break}if(d){for(let d=0;d<c;d++)t(d,b);for(let d=b;d>0;d--)for(let b=0;b<c;b++)f[d*c+b]=f[(d-1)*c+b];for(let b=0;b<c;b++)f[b]=0;a++,G++,b++}}switch(a){case 1:n+=100;break;case 2:n+=300;break;case 3:n+=500;break;case 4:n+=800;break}}function p(a){for(let b=0;b<a.shape.length;b++)for(let d=0;d<a.shape[b].length;d++){if(!a.shape[b][d])continue;let e=a.x+d,g=a.y+b;if(e<0||e>=c||g>=o||g>=0&&f[g*c+e])return!0}return!1}function P(a,c){j.apply(),g.drawRect(h+a*b,i+c*b,h+(a+1)*b-1,i+(c+1)*b-1)}function w(a){j.set(0,1,0).apply(),g.drawRect(a.x1,a.y1,a.x2,a.y2)}function k(b){for(let c=0;c<a.shape.length;c++)for(let d=0;d<a.shape[c].length;d++)a.shape[c][d]&&(b?t(a.x+d,a.y+c):P(a.x+d,a.y+c))}function y(){j.apply();for(let a=0;a<o;a++)for(let b=0;b<c;b++)f[a*c+b]?P(b,a):t(b,a);$(),Y(),_()}function Q(){x();const a=v/2;const b=r/2;g.clear(),g.setColor('#0F0'),g.setFont('6x8',4),g.drawString('GAME OVER',a,b-20),g.setColor('#FFF'),g.setFont('6x8',2),g.drawString('Press    to RESTART',a,b+15),R('USER/Piptris/gear.json',a-45,b+1),g.setColor('#0F0'),g.setFont('6x8',2),g.drawString('Score: '+n,a,b+50),u=setInterval(()=>{BTN_PLAY.read()&&(clearInterval(u),W())},100)}function R(a,b,c){try{let e=fs.readFileSync(a);let d=JSON.parse(e);let f={bpp:d.bpp,buffer:atob(d.buffer),height:d.height,transparent:d.transparent,width:d.width};j.apply(),g.drawImage(f,b,c)}catch(a){console.log('Failed to load image:',a)}}function Y(){const a=d.x1-65;const b=d.y2-60;const c=20;g.setFont('6x8',2);const e=G.toString();const f=g.stringWidth(e);const h=16;g.setColor('#000'),g.fillRect(a-f/2-2,b+c-6,a+f/2+2,b+c+h-4),g.setColor('#FFF'),g.drawString('LINES',a,b),j.apply(),g.drawString(e,a,b+c)}function Z(){const c=20;const a=d.x1-65;const b=d.y1+25;g.setColor('#FFF'),g.setFont('6x8',2),g.drawString(C,a,b),j.apply(),g.setFont('6x8',1),g.drawString('v'+D,a,b+c)}function _(){if(!l)return;const c=d.x2+65;const a=d.y2-60;const f=40;const i=40;g.setColor('#000'),g.fillRect(c-f/2-2,a+15,c+f/2,a+15+i),g.setFont('6x8',2),g.setColor('#FFF'),g.drawString('NEXT',c,a),j.apply();const e=l.shape;const k=e[0].length*b;const h=c-k/2-2;for(let d=0;d<e.length;d++)for(let j=0;j<e[d].length;j++)e[d][j]&&g.drawRect(h+j*b,a+20+d*b,h+(j+1)*b-1,a+20+(d+1)*b-1)}function S(){if(!a||m)return;if(k(!0),a.y++,p(a)&&(a.y--,k(!1),T(a),O(),A(),p(a))){m=!0,clearInterval(e),setTimeout(Q,50);return}k(!1),w(d);const c=BTN_PLAY.read();const b=c?100:F;e._interval!==b&&(clearInterval(e),e=setInterval(S,b))}function $(){const a=d.x2+65;const b=d.y1+25;const c=20;g.setFont('6x8',2);const e=n.toString();const f=g.stringWidth(e);const h=16;g.setColor('#000'),g.fillRect(a-f/2-2,b+c-6,a+f/2+2,b+c+h-4),g.setColor('#FFF'),g.drawString('SCORE',a,b),j.apply(),g.drawString(e,a,b+c)}function a0(){x();const a=v/2;const b=r/2;g.clear(),g.setColor('#0F0'),g.setFont('6x8',4),g.drawString(C,a,b-20),g.setColor('#FFF'),g.setFont('6x8',2),g.drawString('Press    to START',a,b+15),R('USER/Piptris/gear.json',a-34,b+1),g.setColor('#FFF'),g.setFont('6x8',1),g.drawString('v'+D,a-15,r-25)}function a1(){if(!a||m)return;k(!0);while(!p(a))a.y++;a.y--,k(!1),T(a),O(),y(),A(),k(!1)}function t(a,c){g.setColor('#000'),g.fillRect(h+a*b,i+c*b,h+(a+1)*b-1,i+(c+1)*b-1)}function z(){let b=Math.floor(Math.random()*N.length);let a=N[b];let d=Math.floor((c-a[0].length)/2);return{shape:a,x:d,y:0}}function a2(){U()}function a3(b){let a=Date.now();if(a-K<X)return;K=a,b===0?a1():a9(b)}function a4(a){a7(a>0?1:-1)}function a5(){V(),clearInterval(e),bC.clear(1).flip(),E.reboot()}function a6(){try{q=fs.readdir(M).filter(a=>a.endsWith('.wav')).sort()}catch(a){print('Failed to load Piptris music files:',a),q=[]}}function T(a){for(let b=0;b<a.shape.length;b++)for(let d=0;d<a.shape[b].length;d++)a.shape[b][d]&&(f[(a.y+b)*c+a.x+d]=1)}function a7(c){if(m||!a)return;let b=a.x;if(a.x+=c,p(a)){a.x=b;return}for(let d=0;d<a.shape.length;d++)for(let e=0;e<a.shape[d].length;e++)a.shape[d][e]&&t(b+e,a.y+d);k(!1),w(d)}function U(){if(!q.length)return;const a=q[Math.floor(Math.random()*q.length)];Pip.audioStop(),Pip.audioStart(M+'/'+a),rd.setVol(.5)}function a8(){f.fill(0),g.setColor('#000'),g.fillRect(h,i,h+c*b-1,i+o*b-1)}function a9(f){if(m||!a)return;const b=a.shape;const e=f>0?b[0].map((c,a)=>b.map(b=>b[b.length-1-a])):b[0].map((c,a)=>b.map(b=>b[a]).reverse());const c=a.shape;if(a.shape=e,p(a)){a.shape=c;return}for(let d=0;d<c.length;d++)for(let g=0;g<c[d].length;g++)c[d][g]&&t(a.x+g,a.y+d);k(!1),w(d)}function V(){Pip.removeAllListeners(H),Pip.removeAllListeners(I),Pip.removeAllListeners(J),Pip.removeAllListeners(L)}function aa(){Pip.on(H,a3),Pip.on(I,a4),Pip.on(J,a5),Pip.on(L,a2)}function A(){l||(l=z()),a=l,l=z(),y(),p(a)&&(m=!0,clearInterval(e),setTimeout(()=>{Q()},50))}function W(){clearInterval(e),V(),a6(),U(),n=0,m=!1,a=null,l=z(),x(),a8(),w(d),A(),y(),Z(),aa(),e=setInterval(S,F)}const B={};const C='Piptris';const D='2.0.0';let a=null;let F=800;let l=null;let b=10;let u=null;let m=!1;let G=0;let e=null;let q=[];let n=0;const v=g.getWidth();const r=g.getHeight();const s={x1:60,x2:v-60,y1:10,y2:r-10};const c=10;const o=20;const f=new Uint8Array(c*o);const h=(s.x1+s.x2)/2-b*c/2;const i=s.y1+(s.y2-s.y1)/2-b*o/2;const d={x1:h-1,y1:i-1,x2:h+c*b,y2:i+o*b};const H='knob1';const I='knob2';const J='torch';const X=100;let K=0;const L='audioStopped';const M='USER/Piptris';const N=[[[1,1,1,1]],[[1,1,1,1]],[[1,1,0],[0,1,1]],[[0,1,1],[1,1,0]],[[1,0,0],[1,1,1]],[[0,0,1],[1,1,1]],[[0,1,0],[1,1,1]],[[1,1],[1,1]]];const j={self:[0,1,0],apply:function(){g.setColor(this.self[0],this.self[1],this.self[2])},get:function(){return this.self},set:function(a,b,c,d){if(a===undefined||b===undefined||c===undefined||d){const a=g.getColor().toString(16);for(let e=0;e<3;e++)this.self[e]=parseInt(a.charAt(e),16)/15}else this.self[0]=a,this.self[1]=b,this.self[2]=c;return this}};return B.run=function(){bC.clear(),a0(),u=setInterval(()=>{BTN_PLAY.read()&&(clearInterval(u),W())},100)},B}Piptris().run()