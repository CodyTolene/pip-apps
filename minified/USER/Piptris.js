function Piptris(){const a={};return a.GAME_NAME='Piptris',a.GAME_VERSION='1.1.0',a.blockSize=10,a.currentPiece=null,a.dropInterval=800,a.dropTimer=null,a.fieldHeight=20,a.fieldWidth=16,a.fieldX=120,a.fieldY=0,a.field=new Uint8Array(a.fieldWidth*a.fieldHeight),a.gameOverFlag=!1,a.inputInterval=null,a.nextPiece=null,a.score=0,a.softDropInterval=null,a.KNOB_DEBOUNCE=100,a.LEFT_KNOB='knob1',a.RIGHT_KNOB='knob2',a.lastLeftKnobTime=0,a.lastRightKnobTime=0,a.SHAPES=[[[1,1,0],[0,1,1]],[[0,1,1],[1,1,0]],[[1,0,0],[1,1,1]],[[0,0,1],[1,1,1]],[[0,1,0],[1,1,1]],[[1,1,1,1]],[[1,1],[1,1]]],a.clearLines=function(){for(let b=a.fieldHeight-1;b>=0;b--){let c=!0;for(let d=0;d<a.fieldWidth;d++)if(!a.getField(d,b)){c=!1;break}if(c){for(let c=b;c>0;c--)for(let b=0;b<a.fieldWidth;b++)a.setField(b,c,a.getField(b,c-1));for(let b=0;b<a.fieldWidth;b++)a.setField(b,0,0);a.score+=100,b++}}},a.collides=function(b){for(let c=0;c<b.shape.length;c++)for(let d=0;d<b.shape[c].length;d++)if(b.shape[c][d]){const e=b.x+d;const f=b.y+c;if(e<0||e>=a.fieldWidth||f>=a.fieldHeight||f>=0&&a.getField(e,f))return!0}return!1},a.drawBlock=function(b,c){bC.setColor(3),bC.fillRect(a.fieldX+b*a.blockSize,a.fieldY+c*a.blockSize,a.fieldX+(b+1)*a.blockSize-1,a.fieldY+(c+1)*a.blockSize-1)},a.drawBorder=function(){bC.setColor(2),bC.drawRect(a.fieldX,a.fieldY,a.fieldX+a.fieldWidth*a.blockSize-1,a.fieldY+a.fieldHeight*a.blockSize-1)},a.drawField=function(){if(a.gameOverFlag)return;bC.clear(1),a.drawBorder(),a.drawScore(),a.drawNextPiece(),a.drawVersion(),a.drawTitle();for(let b=0;b<a.fieldHeight;b++)for(let c=0;c<a.fieldWidth;c++)a.getField(c,b)&&a.drawBlock(c,b);if(a.currentPiece)for(let b=0;b<a.currentPiece.shape.length;b++){const c=a.currentPiece.shape[b];for(let d=0;d<c.length;d++)c[d]&&a.drawBlock(a.currentPiece.x+d,a.currentPiece.y+b)}bC.flip()},a.drawGearIcon=function(e,f,g){bC.setColor(3);const d=2*g;const c=4*g;const h=3*g;const i=1*g;const a=c*.707;const b=(a,b)=>bC.fillRect(e+a-d/2,f+b-d/2,e+a+d/2,f+b+d/2);b(-c,0),b(c,0),b(0,-c),b(0,c),b(-a,-a),b(a,-a),b(-a,a),b(a,a),bC.fillCircle(e,f,h),bC.setColor(0),bC.fillCircle(e,f,i)},a.drawNextPiece=function(){if(!a.nextPiece)return;bC.setColor(3),bC.setFontMonofonto18();const b=a.fieldX+a.fieldWidth*a.blockSize+10;bC.drawString('Next:',b,a.fieldY);for(let c=0;c<a.nextPiece.shape.length;c++){const d=a.nextPiece.shape[c];for(let e=0;e<d.length;e++)d[e]&&bC.fillRect(b+e*a.blockSize,a.fieldY+20+c*a.blockSize,b+(e+1)*a.blockSize-1,a.fieldY+20+(c+1)*a.blockSize-1)}},a.drawScore=function(){bC.setColor(3),bC.setFontMonofonto18(),bC.drawString('Score:',a.fieldX-80,a.fieldY),bC.drawString(a.score.toString(),a.fieldX-80,a.fieldY+20)},a.drawTitle=function(){bC.setColor(3),bC.setFontMonofonto16(),bC.drawString(a.GAME_NAME,a.fieldX-80,bC.getHeight()-30)},a.drawVersion=function(){bC.setColor(3),bC.setFontMonofonto16();const b=a.fieldX+a.fieldWidth*a.blockSize+10;bC.drawString('v'+a.GAME_VERSION,b,bC.getHeight()-30)},a.drop=function(){if(!a.currentPiece||a.gameOverFlag)return;a.currentPiece.y++,a.collides(a.currentPiece)&&(a.currentPiece.y--,a.merge(a.currentPiece),a.clearLines(),a.spawnPiece()),a.drawField()},a.dropToBottom=function(){if(!a.currentPiece||a.gameOverFlag)return;while(!0)if(a.currentPiece.y++,a.collides(a.currentPiece)){a.currentPiece.y--;break}a.merge(a.currentPiece),a.clearLines(),a.spawnPiece(),a.drawField()},a.endGame=function(){clearInterval(a.dropTimer),clearInterval(a.softDropInterval),a.gameOverFlag=!0,bC.clear(1),bC.setColor(3),bC.setFontMonofonto23(),bC.drawString('GAME OVER',120,40),bC.setFontMonofonto18(),bC.drawString('Score: '+a.score,120,70),bC.setFontMonofonto16(),bC.drawString('Press    to restart',120,100),a.drawGearIcon(175,110,2),bC.flip(),a.inputInterval&&clearInterval(a.inputInterval),a.inputInterval=setInterval(()=>{BTN_PLAY.read()&&(clearInterval(a.inputInterval),a.restartGame())},100)},a.getField=function(b,c){return a.field[c*a.fieldWidth+b]},a.getRandomPiece=function(){const b=a.SHAPES[Math.floor(Math.random()*a.SHAPES.length)];const c=Math.floor((a.fieldWidth-b[0].length)/2);return{shape:b,x:c,y:0}},a.merge=function(b){for(let c=0;c<b.shape.length;c++){const d=b.shape[c];for(let e=0;e<d.length;e++)d[e]&&a.setField(b.x+e,b.y+c,1)}},a.move=function(c){if(a.gameOverFlag||!a.currentPiece)return;const b=a.currentPiece.x+c;if(b<0||b+a.currentPiece.shape[0].length>a.fieldWidth)return;a.currentPiece.x=b,a.collides(a.currentPiece)&&(a.currentPiece.x-=c),a.drawField()},a.resetPlayfield=function(){for(let b=0;b<a.field.length;b++)a.field[b]=0},a.restartGame=function(){a.inputInterval&&clearInterval(a.inputInterval),a.dropTimer&&clearInterval(a.dropTimer),a.softDropInterval&&clearInterval(a.softDropInterval),a.gameOverFlag=!1,a.score=0,a.resetPlayfield(),a.nextPiece=a.getRandomPiece(),a.spawnPiece(),a.drawField(),a.dropTimer=setInterval(()=>a.drop(),a.dropInterval),a.softDropInterval=setInterval(()=>{!a.gameOverFlag&&BTN_PLAY.read()&&a.drop()},100)},a.rotate=function(e){if(a.gameOverFlag)return;const b=a.currentPiece.shape;const c=e>0?b[0].map((c,a)=>b.map(b=>b[b.length-1-a])):b[0].map((c,a)=>b.map(b=>b[a]).reverse());const d=a.currentPiece.shape;a.currentPiece.shape=c,a.collides(a.currentPiece)&&(a.currentPiece.shape=d),a.drawField()},a.run=function(){Pip.removeAllListeners(a.LEFT_KNOB),Pip.removeAllListeners(a.RIGHT_KNOB),Pip.on(a.LEFT_KNOB,c=>{const b=Date.now();if(b-a.lastLeftKnobTime<a.KNOB_DEBOUNCE)return;a.lastLeftKnobTime=b,c===0?a.gameOverFlag?a.restartGame():a.dropToBottom():a.rotate(c)}),Pip.on(a.RIGHT_KNOB,c=>{const b=Date.now();if(b-a.lastRightKnobTime<a.KNOB_DEBOUNCE)return;a.lastRightKnobTime=b,a.gameOverFlag&&c===0?a.restartGame():a.move(c>0?1:-1)}),setWatch(()=>{clearInterval(a.dropTimer),a.inputInterval&&clearInterval(a.inputInterval),bC.clear(1).flip(),E.reboot()},BTN_TORCH,{repeat:!0,edge:'rising',debounce:10}),a.restartGame()},a.setField=function(b,c,d){a.field[c*a.fieldWidth+b]=d},a.spawnPiece=function(){a.currentPiece=a.nextPiece||a.getRandomPiece(),a.nextPiece=a.getRandomPiece(),a.collides(a.currentPiece)&&a.endGame()},a}Piptris().run()